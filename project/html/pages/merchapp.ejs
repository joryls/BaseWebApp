<html lang="en">
<head>
    <% include ../helpers/head %>

<SCRIPT LANGUAGE=javascript>

  const skus = [];
  const datestuff = [];
  const promo = [];
  const promoupc = [];
  var vstore = ""
  var vuser = ""

  function OnLoad() {
    var dbRef = firebase.database().ref('TrueSet').limitToLast(1); //this pulls most recent day's data to define item list
    dbRef.once('value')
      .then(function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
          var childData = childSnapshot.val();
          //console.log(childData['store'][0]['data'][0]['DayNum']);
          datestuff.push(childData['store'][0]['data'][0]['DayNum']);
          var dl = childData['store'][0]['data'].length;
          for (i = 0; i < dl; i++) {
            skus.push(childData['store'][0]['data'][i]['UPC']);
          }
        });
      });  

    //load promo object here
    var dbRef = firebase.database().ref('promo').orderByChild('upc');

    dbRef.once('value')
      .then(function(snapshot) {
        var promoData = snapshot.val();
        promo.push(promoData);
        //console.log(promoData); 
      });

    //console.log(promo);
    //console.log(promo.length);
    //console.log(skus);
    //console.log(skus.length);
    //console.log(datestuff);
    //console.log(datestuff.length)
  
    //console.log(datestuff[0]);
    daynum = datestuff[0];
    //console.log(daynum);

    //go through promo and log any upc on sale today to promoupc
    for (i=0; i < promo.length; i++) {
      console.log(datestuff[0]);
      if (datestuff[0] >= promo[i]['startnum'] && datestuff[0] <= promo[i]['endnum']) {
        promoupc.push(promoData[i]['upc'])
      }
    }
  }

  function OnChange(dropdown)  {
    //exception handling for when dropdown list is removed
    try {
      var myindex  = dropdown.selectedIndex;
    }

    catch ( e ) {
         // Code to run if an exception occurs
         return;
    }
    var SelValue = dropdown.options[myindex].value;
    vstore = SelValue;
    //clear previously selected store data if present
    document.getElementById('clicker').innerHTML = "";
    document.getElementById('labels').innerHTML = "";
    document.getElementById('dataHere').innerHTML = "";
    document.getElementById('commentsHere').innerHTML = "";

    //get list of dbobject by Category
    //var query = dbRef.orderByChild("Category");
    //console.log(query)
    
    var pushme = document.createElement("input");
    pushme.id = "confirm";
    pushme.type = "button";
    pushme.value = "Done";
    pushme.onclick = OnClick;
    document.getElementById('clicker').append(pushme);
    //pushme.onclick = OnClick();

    var lnbreak = document.createElement("br");
    var para = document.createElement("h2");
    var para2 = document.createElement("h4");
    var para3 = document.createElement("h4");
    para.innerHTML = "Product Name (Units Received | Sold)";
    para2.innerHTML = "ON SHELF";
    para3.innerHTML = "IN STOCK";
    document.getElementById('labels').appendChild(para);
    document.getElementById('labels').appendChild(para3);
    document.getElementById('labels').appendChild(para2);
    //document.getElementById('headHere').appendChild(lnbreak);

    var dbRef = firebase.database().ref('TrueSet').limitToLast(7);
    const prodlist = [];
    const addedprod = [];
    dbRef.once('value')
      .then(function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
          //console.log(childsnapshot.value)
          var key = childSnapshot.key;
          console.log(key);
          var childData = childSnapshot.val();
          //console.log(childData);

          //iterate through each childData set, create store + items container in prodlist, populate items
          //updating sold/received values for each store
          var dl = childData['store'].length;
          //console.log(dl);
          //console.log(SelValue);
          for (i = 0; i < dl; i++) {
            var store = childData['store'][i]["Store"];
            //console.log(store)
            if (store == SelValue) {
              var il = childData['store'][i]['data'].length;
              for (j = 0; j <il; j++) {
              //console.log(il);
                var upc = childData['store'][i]['data'][j]['UPC'];
                //console.log(upc);
                if ((skus.includes(upc)) && (!(addedprod.includes(upc)))) {
                  addedprod.push(upc);
                  //console.log(addedprod.length);
                  //if (childData['store'][i]['data'][j]['UPC'] not in prodlist['UPC'] 
                  prodlist.push([childData['store'][i]['data'][j]['UPC'],
                                childData['store'][i]['data'][j]['Category'],
                                childData['store'][i]['data'][j]['Name'],
                                childData['store'][i]['data'][j]['UnitRecieved'],
                                childData['store'][i]['data'][j]['UnitSales'],
                                childData['store'][i]['data'][j]['Subcategory']])
                } else if (!(skus.includes(upc))) {
                  //do nothing
                } else {
                  var plen = prodlist.length;
                  //console.log(plen);
                  for (k = 0; k < plen; k++) {
                    if (upc == prodlist[k][0]) {
                      prodlist[k][3] += childData['store'][i]['data'][j]['UnitRecieved'];
                      prodlist[k][4] += childData['store'][i]['data'][j]['UnitSales'];
                      }
                    }
                  }
                }  
              }
            }
          })    //prodlist populated
          

    //console.log(prodlist);

    //build category & subcategory labels
    let currcat = "";
    let cursubcat = "";
    
    //iterate through where store matches selected add products to list
    //create list item, checkboxes and publish to UI.
    let prodlen = prodlist.length;
    //console.log(prodlen);
    for (i = 0; i < prodlen; i++) {         
      if ((currcat != prodlist[i][1]) && (cursubcat != prodlist[i][5])) {
        let catlabel = document.createElement("h3");
        catlabel.innerHTML = prodlist[i][1];
        currcat = prodlist[i][1];
        document.getElementById('dataHere').appendChild(catlabel);

        let subcatlabel = document.createElement("h3");
        subcatlabel.innerHTML = prodlist[i][5];
        cursubcat = prodlist[i][5];
        document.getElementById('dataHere').appendChild(subcatlabel);

        //define sales price element and include in 'item' object when applicable (do 3 places below)
        //console.log(promo);
        if (prodlist[i][0] in promoupc) { //need to do date check when populating promoupc
          //get sales price for upc
          //create item object below 
          //replicate rest of code for nonpromo items
        } else {
          let item = prodlist[i][2] + " (" + prodlist[i][3] + " | " + prodlist[i][4] + ")   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . ";
          //console.log(item);
          let ckbx = document.createElement("input");
          ckbx.id = "slf"+prodlist[i][0];
          ckbx.type = "checkbox";
          let ckbx2 = document.createElement("input");
          ckbx2.id = "stk"+prodlist[i][0];
          ckbx2.type = "checkbox";
          let prodName = document.createElement("p");
          prodName.innerHTML = item;
          prodName.setAttribute("child-key", prodlist[i][0]);
          prodName.setAttribute("name", prodlist[i][2]);
            
          document.getElementById('dataHere').appendChild(ckbx);
          document.getElementById('dataHere').appendChild(ckbx2);
          document.getElementById('dataHere').appendChild(prodName);
        }

        } else if (cursubcat != prodlist[i][5]) {
          let subcatlabel = document.createElement("h3");
          subcatlabel.innerHTML = prodlist[i][5];
          cursubcat = prodlist[i][5];
          document.getElementById('dataHere').appendChild(subcatlabel);

          if (prodlist[i][0] in promoupc) {
            //get sales price for upc
            //create item object below 
            //replicate rest of code for nonpromo items
          } else {
            let item = prodlist[i][2] + " (" + prodlist[i][3] + " | " + prodlist[i][4] + ")   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . ";
            //console.log(item);
            let ckbx = document.createElement("input");
            ckbx.id = "slf"+prodlist[i][0];
            ckbx.type = "checkbox";
            let ckbx2 = document.createElement("input");
            ckbx2.id = "stk"+prodlist[i][0];
            ckbx2.type = "checkbox";
            let prodName = document.createElement("p");
            prodName.innerHTML = item;
            prodName.setAttribute("child-key", prodlist[i][0]);
            prodName.setAttribute("name", prodlist[i][2]);
            
            document.getElementById('dataHere').appendChild(ckbx);
            document.getElementById('dataHere').appendChild(ckbx2);
            document.getElementById('dataHere').appendChild(prodName);
          }
        } else {
          if (prodlist[i][0] in promoupc) {
            //get sales price for upc
            //create item object below 
            //replicate rest of code for nonpromo items
          } else {
            let item = prodlist[i][2] + " (" + prodlist[i][3] + " | " + prodlist[i][4] + ")   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . ";
            //console.log(item);
            let ckbx = document.createElement("input");
            ckbx.id = "slf"+prodlist[i][0];
            ckbx.type = "checkbox";
            let ckbx2 = document.createElement("input");
            ckbx2.id = "stk"+prodlist[i][0];
            ckbx2.type = "checkbox";
            let prodName = document.createElement("p");
            prodName.innerHTML = item;
            prodName.setAttribute("child-key", prodlist[i][0]);
            prodName.setAttribute("name", prodlist[i][2]);
            
            document.getElementById('dataHere').appendChild(ckbx);
            document.getElementById('dataHere').appendChild(ckbx2);
            document.getElementById('dataHere').appendChild(prodName);
            }
          }       
        }         
        })

    //create text inputs for comments
    var userId = firebase.auth().currentUser.uid;
    var userEmail = firebase.auth().currentUser.email;
    //console.log(userEmail);
    vuser = userEmail;

    var priceComm = document.createElement("input");
    priceComm.id = "price"+userId;
    priceComm.type = "text";
    priceComm.size = 80;
    //priceComm.float = "left";

    var presComm = document.createElement("input");
    presComm.id = "pres"+userId;
    presComm.type = "text";
    presComm.size = 80;
    //presComm.float = "left";
    
    var para4 = document.createElement("h2");
    var para5 = document.createElement("h2");
    para4.innerHTML = "Note any pricing issues here:"
    para5.innerHTML = "Note any presentation issues here:"

    document.getElementById('commentsHere').appendChild(para4);  
    document.getElementById('commentsHere').appendChild(priceComm);
    document.getElementById('commentsHere').appendChild(para5);
    document.getElementById('commentsHere').appendChild(presComm);

    return(SelValue);
    return(userID);
  }
  
  var dataobject = [];

  function OnClick(button) {

    console.log(vstore);
    console.log(vuser);
    var vcomm = [];
    var vprod = [];
    var cdate = new Date();
    var cDay = cdate.getDate();
    var cMonth = cdate.getMonth() + 1;
    var cYear = cdate.getFullYear();
    var vdate = (cMonth +"/"+cDay+"/"+cYear);

        
    //console.log(dataobject);

    var data = document.getElementById("dataHere");
    var comm = document.getElementById("commentsHere");

    var dataprod = data.getElementsByTagName("p");
    var datalmts = data.getElementsByTagName("input");
    var commlmts = comm.getElementsByTagName("input");
    var pl = dataprod.length;
    var dl = datalmts.length;
    var cl = commlmts.length;

    //collect input data in object
    //access html elments, extract contained data, and arrange
    
    //add comments to data obj under visit level with prod details in sub object
    for (i = 0; i < cl; i++) {
      let obj = { id: commlmts[i].id,
                  comment: commlmts[i].value};
      vcomm.push(obj);
    }

    let j = 0;
    for (i = 0; i < pl; i++) {
      var obj = { name: dataprod[i].getAttribute('name'),
                  product: dataprod[i].getAttribute('child-key'),
                  instock: datalmts[j].checked,
                  onshelf: datalmts[j+1].checked };
                  j += 2
      vprod.push(obj);
    }
    //console.log(datalmts);
    dataobject.push(vstore);
    dataobject.push(vuser);
    dataobject.push(vdate);
    //console.log(vcomm);
    dataobject.push(vcomm);
    dataobject.push(vprod);
    //console.log(dataobject);
 
    //clear previous view data
    document.getElementById('storelist').innerHTML = "Products to order:";
    document.getElementById('clicker').innerHTML = "";
    document.getElementById('labels').innerHTML = "";
    document.getElementById('dataHere').innerHTML = "";
    document.getElementById('commentsHere').innerHTML = "";

    //publish new data for ordering view
    var pushme2 = document.createElement("input");
    pushme2.id = "confirmorder";
    pushme2.type = "button";
    pushme2.value = "Done";
    pushme2.onclick = OnClick2;
    document.getElementById('clicker').append(pushme2);

    var lnbreak = document.createElement("br");
    var para = document.createElement("h2");
    var para3 = document.createElement("h5");
    para.innerHTML = "Product Name (UPC/SKU)";
    para3.innerHTML = "Ordered";
    document.getElementById('labels').appendChild(para);
    document.getElementById('labels').appendChild(para3);
    
    var pl = dataobject[4].length
    for (i = 0; i < pl; i++) {
      //console.log(item);
      if (dataobject[4][i].instock == false)  {
        let line = dataobject[4][i].name + " (" + dataobject[4][i].product + ")   . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . ";
        let prodName = document.createElement("p");
        let ckbx = document.createElement("input");
        let linebreak = document.createElement("br");
        ckbx.id = "ord"+dataobject[4][i].product;
        ckbx.type = "checkbox";
        prodName.innerHTML = line;
        prodName.setAttribute("child-key", dataobject[4][i].product);
        prodName.setAttribute("name", dataobject[4][i].name);
        document.getElementById('dataHere').appendChild(ckbx);
        document.getElementById('dataHere').appendChild(prodName);
      } 
    }
      //return(dataobject);
  }

  const ordered = [];
  function OnClick2(button) {
    //collect ordered checks and add to dataObj
    //console.log(dataobject);
    var data = document.getElementById("dataHere");
    var dataprod = data.getElementsByTagName("p");
    var datalmts = data.getElementsByTagName("input");
    
    var cl = datalmts.length;
    //console.log(cl);
    var pl = dataprod.length;
    //console.log(pl);
    var dl = dataobject[4].length;
    //console.log(dl);
    //create array of ordered inputs
    
    for (i = 0; i < cl; i++) {
      var obj = { name: dataprod[i].getAttribute('name'),
                  product: dataprod[i].getAttribute('child-key'),
                  ordered: datalmts[i].checked};
      ordered.push(obj);
    }
    
    //console.log(ordered);
    
    //add ordered t/f value to dataobject[4];
    for (i=0; i<dl; i++) {
      if (dataobject[4][i]['instock'] == true) {
        dataobject[4][i]['ordered'] = false;
      } else {
      for (j=0; j<pl; j++) {
        //console.log(dataobject[4][i]['product'])
        //console.log(ordered[j]['product'])
        if (dataobject[4][i]['product'] == ordered[j]['product']) {
          dataobject[4][i]['ordered'] = ordered[j]['ordered'];
          }
        }
      }
    }
    //console.log(ordered);
    console.log(dataobject);

    //push visit to database ref('visits')

    //var dbRef = firebase.database().ref('visits');
    //dbRef.push(dataobject);

    //log user out of firebase
    //firebase.auth().signOut();
    //clear all elements
    document.getElementById('storelist').innerHTML = "You are logged out, you may close the app.";
    document.getElementById('clicker').innerHTML = "";
    document.getElementById('labels').innerHTML = "";
    document.getElementById('dataHere').innerHTML = "";
    document.getElementById('commentsHere').innerHTML = "";
    
  }
    //access database
    

    //write data to db

  OnLoad();
  
</SCRIPT>

</head>

<body>
  <!-- the classes 'page-header' and 'btn btn-dark' create bootstrap components.  -->
  <!-- Check out more components here: http://getbootstrap.com/components/ -->
  <div class="page-header" id="page-header">
  
    <h1>storelevel Test App</h1>

    <form id="clicker">

    </form>

    <form id="storelist">
      <select name="stores" id="stores" onchange='OnChange(this.form.stores)'>
        <option value="Choose Store">Choose Store</option>
        <option value="50th Street Edina">50th Street Edina</option>
        <option value="Bloomington">Bloomington</option>
        <option value="Burnsville">Burnsville</option>
        <option value="Chanhassen">Chanhassen</option>
        <option value="Downtown Minneapolis">Downtown Minneapolis</option>
        <option value="Downtown St. Paul">Downtown St. Paul</option>
        <option value="Eagan">Eagan</option>
        <option value="Eden Prairie">Eden Prairie</option>
        <option value="France Avenue Edina">France Avenue Edina</option>
        <option value="Glen Lake">Glen Lake</option>
        <option value="Golden Valley">Golden Valley</option>
        <option value="Highland Park">Highland Park</option>
        <option value="Hwy.7 Minnetonka">Hwy.7 Minnetonka</option>
        <option value="Maple Grove">Maple Grove</option>
        <option value="Navarre">Navarre</option>
        <option value="Northeast Minneapolis">Northeast Minneapolis</option>
        <option value="Plymouth">Plymouth</option>
        <option value="Prior Lake">Prior Lake</option>
        <option value="Richfield">Richfield</option>
        <option value="Ridgedale">Ridgedale</option>
        <option value="Roseville">Roseville</option>
        <option value="St. Cloud">St. Cloud</option>
        <option value="St. Louis Park">St. Louis Park</option>
        <option value="Uptown Minneapolis">Uptown Minneapolis</option>
        <option value="Wayzata">Wayzata</option>
        <option value="White Bear Lake">White Bear Lake</option>
        <option value="Woodbury">Woodbury</option>
      </select>
    </form>

  </div>
  
  <div id="labels"></div>

  <br><br>

  <div id="dataHere"></div>

  <div id="commentsHere"></div>

</body>

</html>